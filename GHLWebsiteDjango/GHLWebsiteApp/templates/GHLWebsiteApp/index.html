{% extends "GHLWebsiteApp/layout.html" %}
{% load static %}
{% load player_tags %}
{% block title %} - Index{% endblock %}
{% block body %}
{% if active_season and active_season.signups_open %}
<div style="
    width: 100%;
    background: #4caf50;
    color: white;
    padding: 12px 0;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
">
    Signups for <span style="text-decoration: underline;">{{ active_season.season_text }}</span> are OPEN! 
    <a href="{% url 'season_signup' %}" style="color: #fff; font-weight: 900; margin-left: 6px; text-decoration: underline;">
        Click here to sign up →
    </a>
</div>
{% endif %}

<center>
    <table>
        <tr class="no-bg">
            <td id="leftside">
                <div class="section">
                    <center>
                        <div class="header">Current Standings</div>
                        {% if not season.season_type == "playoffs" %}
                        <table class="standingstable">
                            <colgroup>
                                <col style="width: 60px">
                                <col style="width: 35px">
                                <col style="width: 35px">
                                <col style="width: 35px">
                                <col style="width: 35px">
                                <col style="width: 35px">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>GP</th>
                                    <th>W</th>
                                    <th>L</th>
                                    <th>OTL</th>
                                    <th>PTS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for standing in standings %}
                                <tr>
                                    <td><a href="{% url 'team' standing.team.ea_club_num %}">{{ standing.team.club_abbr }}</a></td>
                                    <td>{{ standing.gp }}</td>
                                    <td>{{ standing.wins }}</td>
                                    <td>{{ standing.losses }}</td>
                                    <td>{{ standing.otlosses }}</td>
                                    <td class="points">{{ standing.points }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div style="flex: auto;">
                            <div id="teamlistcontainer" style="display: inline-flex; margin: 5px;">
                            {% for team in activeteams %}
                                <a href="{% url 'team' team.ea_club_num %}">
                                    <div class="teamlogo" title="{{ team.club_full_name }}" style="padding: 2px;">
                                        <img src="{{ team.team_logo_link }}" height=24 width=24 />
                                    </div>
                                </a>
                            {% endfor %}
                            </div>
                            <div>
                                <a href="{% url 'standings' %}" style="text-decoration: none;">Click here for playoff tree</a>
                            </div>
                        </div>
                        {% endif %}
                    </center>
                </div>
                <div class="section">
                    <div class="header">Player Leaders</div>
                    <center><table class="standingstable">
                        <colgroup>
                            <col style="width: 45px">
                            <col style="width: 160px">
                            <col style="width: 60px">
                        </colgroup>
                        {% for leader in leaders %}
                        <tr>
                            <td>{{ leader.attribute }}</td>
                            <td class="points">{{ leader.player__username }}</td>
                            {% if leader.attribute == "SV%" or leader.attribute == "SH%" %}
                            <td>{{ leader.stat|floatformat:1 }}%</td>
                            {% elif leader.attribute == "GAA" %}
                            <td>{{ leader.stat|floatformat:2 }}</td>
                            {% else %}
                            <td>{{ leader.stat|floatformat:0 }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </table></center>
                </div>
            </td>

            <td id="rightside">
                <div class="section">
                    <h1>Announcements</h1>
                    <div class="bodytext">
                        {% if announcement %}
                            {% for announcement in announcement %}
                            <div class="announcement">
                                <p>{{ announcement.content|tag_players|linebreaks|safe }}</p>
                                <p style="font-size: 11px;"><i>- {{ announcement.author.username|default:"GHLBot" }}, {{ announcement.created_at|date:"D M j, Y @ g:i A" }}</i></p>
                            </div>
                            {% endfor %}
                            <div class="pagination">
                                {% if announcement.has_previous %}
                                    <a href="?page={{ announcement_page.previous_page_number }}"><div>&#171;</div></a>
                                {% endif %}
                                    <div>Page {{ announcement.number }} of {{ announcement.paginator.num_pages }}</div>
                                {% if announcement.has_next %}
                                    <a href="?page={{ announcement.next_page_number }}"><div>&#187;</div></a>
                                {% endif %}
                            </div>
                        {% else %}
                            <p>No announcements at this time.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="section" style="padding-top: 0;">
                    <div class="header">Player Focus</div>
                    <div class="subsection-container">
                        <div id="playerfocustable">
                            <center><table>
                                <col style="width: 35%;">
                                <col style="width: 65%;">

                                <tr>
                                    <td>Username:</td>
                                    <td>{{ username }}</td>
                                </tr>
                                <tr>
                                    <td>Primary Pos:</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>Secondary Pos:</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>Games Played:</td>
                                    <td>{{ gp }}</td>
                                </tr>
                                <tr>
                                    <td>Goals:</td>
                                    <td>{{ goals }}</td>
                                </tr>
                                <tr>
                                    <td>Assists:</td>
                                    <td>{{ assists }}</td>
                                </tr>
                                <tr>
                                    <td>+/-:</td>
                                    <td>{{ plusminus }}</td>
                                </tr>
                                <tr>
                                    <td>PIMs:</td>
                                    <td>{{ pims }}</td>
                                </tr>
                            </table></center>
                        </div>
                        <div id="playerfocusimg">
                            <img src="https://avatar-ssl.xboxlive.com/avatar/{{ username }}/avatar-body.png" class="ghl-avatar" alt="Xbox Avatar" data-fallback="{% static 'GHLWebsiteApp/stock-user-photo.jpg' %}">
                        </div>
                        <script>
                        document.addEventListener("DOMContentLoaded", () => {
                        document.querySelectorAll("img.ghl-avatar").forEach(img => {
                            const fallback = img.dataset.fallback;

                            img.onload = () => {
                            // Create canvas to inspect pixel data
                            const canvas = document.createElement("canvas");
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            const ctx = canvas.getContext("2d");
                            ctx.drawImage(img, 0, 0);

                            // Read a pixel — if fully transparent, replace image
                            const pixel = ctx.getImageData(0, 0, 1, 1).data;
                            const isTransparent = pixel[3] === 0;

                            if (isTransparent) {
                                img.src = fallback;
                                img.classList.add("fallback-avatar");
                            }
                            };

                            img.onerror = () => {
                            img.src = fallback;
                            img.classList.add("fallback-avatar");
                            };
                        });
                        });
                        </script>
                    </div>
                </div>
            </td>
        </table></center>
{% endblock %}